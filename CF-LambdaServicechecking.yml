AWSTemplateFormatVersion: '2010-09-09'
Description: Create a Lambda function that checks for AWS service issues using AWS Health API.

Resources:

  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: LambdaHealthCheckExecutionRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: LambdaHealthCheckPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - health:DescribeEvents
                Resource: "*"

  HealthCheckLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: AWSHealthStatusChecker
      Runtime: python3.12
      Role: !GetAtt LambdaExecutionRole.Arn
      Handler: index.lambda_handler
      Timeout: 60
      Code:
        ZipFile: |
          import boto3
          import datetime

          def lambda_handler(event, context):
              client = boto3.client('health')
              now = datetime.datetime.utcnow()
              start_time = now - datetime.timedelta(hours=24)

              response = client.describe_events(
                  filter={
                      'startTimes': [
                          {
                              'from': start_time,
                              'to': now
                          },
                      ],
                      'eventStatusCodes': ['open', 'upcoming']
                  }
              )

              events = response.get('events', [])
              if events:
                  print(f"{len(events)} service issue(s) detected:")
                  for event in events:
                      print(f"- {event['service']} - {event['eventTypeCode']} - {event['eventTypeCategory']}")
              else:
                  print("All AWS services are operating normally.")

Outputs:
  LambdaFunctionName:
    Description: Name of the Lambda Function
    Value: !Ref HealthCheckLambdaFunction
